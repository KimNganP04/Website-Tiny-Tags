<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin - Qu·∫£n l√Ω ƒë∆°n h√†ng & Tin nh·∫Øn</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-light: #ffffff;
            --text-muted: #a0a0a0;
            --accent: #fe2c55;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #ef4444;
            --border: #404040;
            --chat-bg: #1f2937;
            --sidebar-bg: #242424;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .admin-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-pending { color: var(--warning); }
        .stat-confirmed { color: var(--accent); }
        .stat-shipping { color: #3b82f6; }
        .stat-delivered { color: var(--success); }
        .stat-messages { color: #8b5cf6; }
        
        .chat-preview {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .chat-preview h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .message-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .message-item.unread {
            border-left: 3px solid var(--accent);
        }
        
        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .message-preview {
            color: var(--text-muted);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: #e0264d;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #10b981;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #f59e0b;
            transform: translateY(-2px);
        }
        
        .btn-chat {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-chat:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .orders-section, .chat-section {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .section-header {
            background: rgba(254, 44, 85, 0.1);
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .section-header h2 {
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: rgba(254, 44, 85, 0.1);
            font-weight: 600;
            color: var(--accent);
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }
        
        .status-pending { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
        .status-confirmed { background: rgba(254, 44, 85, 0.2); color: var(--accent); }
        .status-shipping { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-delivered { background: rgba(52, 211, 153, 0.2); color: var(--success); }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 2px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .btn-view { background: #3b82f6; color: white; }
        .btn-edit { background: var(--warning); color: white; }
        .btn-delete { background: var(--danger); color: white; }
        
        .action-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Messenger-style chat interface */
        .messenger-container {
            display: flex;
            height: 600px;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .conversations-list {
            width: 350px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
        }

        .conversation-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(254, 44, 85, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-header h3 {
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .conversation-item.active {
            background: rgba(254, 44, 85, 0.1);
            border-left: 3px solid var(--accent);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            color: var(--text-muted);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .conversation-unread {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(254, 44, 85, 0.05);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-weight: 600;
        }

        .chat-header-status {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--chat-bg);
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }

        .customer-message {
            background: #374151;
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .admin-message {
            background: var(--accent);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input-area {
            display: flex;
            border-top: 1px solid var(--border);
            padding: 15px;
            background: var(--bg-card);
            align-items: center;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            outline: none;
            background: var(--bg-dark);
            color: var(--text-light);
        }

        .chat-input-area button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .chat-input-area button:hover {
            background: #e0264d;
            transform: translateY(-2px);
        }

        .image-upload-btn {
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 10px;
        }

        .image-upload-btn:hover {
            color: #fff;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: var(--accent);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .order-details {
            display: grid;
            gap: 20px;
        }

        .detail-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .detail-section h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .product-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-price {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .status-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: inherit;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-confirm { background: var(--success); color: white; }
        .btn-shipping { background: #3b82f6; color: white; }
        .btn-deliver { background: var(--success); color: white; }
        .btn-cancel { background: var(--danger); color: white; }

        .quick-action-btn:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        /* New styles for better organization */
        .order-number {
            background: var(--accent);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }

        .order-date {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .order-row-new {
            background: rgba(254, 44, 85, 0.1);
        }

        .delete-conversation-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .delete-conversation-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Firebase status */
        .firebase-status {
            position: fixed;
            top: 80px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            background: #4CAF50;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 250px;
            word-wrap: break-word;
        }

        .status-connected { 
            background: #4CAF50; 
            animation: fadeOut 2s ease-in-out 2s forwards;
        }

        .status-disconnected { 
            background: #f44336; 
        }

        .status-connecting { 
            background: #ff9800; 
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .content-area {
                grid-template-columns: 1fr;
            }
            
            .messenger-container {
                flex-direction: column;
                height: 700px;
            }
            
            .conversations-list {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px 8px;
            }

            .modal-content {
                padding: 20px;
            }

            .quick-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Status -->
    <div class="firebase-status status-connecting" id="firebaseStatus">
        <i class="fas fa-sync fa-spin"></i> ƒêang k·∫øt n·ªëi Firebase...
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <h1>üõçÔ∏è Qu·∫£n l√Ω ƒë∆°n h√†ng & Tin nh·∫Øn</h1>
            <p>Theo d√µi ƒë∆°n h√†ng v√† tr·∫£ l·ªùi tin nh·∫Øn kh√°ch h√†ng</p>
        </div>
        
        <div class="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number stat-pending" id="pending-count">0</div>
                    <div>Ch·ªù x·ª≠ l√Ω</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-confirmed" id="confirmed-count">0</div>
                    <div>ƒê√£ x√°c nh·∫≠n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-shipping" id="shipping-count">0</div>
                    <div>ƒêang giao</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-delivered" id="delivered-count">0</div>
                    <div>Ho√†n th√†nh</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-messages" id="messages-count">0</div>
                    <div>Tin nh·∫Øn m·ªõi</div>
                </div>
            </div>
            
            <div class="chat-preview">
                <h3><i class="fas fa-comments"></i> Tin nh·∫Øn g·∫ßn ƒë√¢y</h3>
                <div id="recent-messages">
                    <!-- Recent messages will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="loadOrders()">
                <i class="fas fa-sync-alt"></i> T·∫£i l·∫°i
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Xu·∫•t Excel
            </button>
            <button class="btn btn-danger" onclick="clearAllData()">
                <i class="fas fa-trash"></i> X√≥a d·ªØ li·ªáu
            </button>
        </div>
        
        <div class="content-area">
            <div class="orders-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-bag"></i> ƒê∆°n h√†ng m·ªõi nh·∫•t</h2>
                </div>
                <div id="orders-list">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
            
            <div class="chat-section">
                <div class="section-header">
                    <h2><i class="fas fa-comment-dots"></i> Tr·∫£ l·ªùi tin nh·∫Øn</h2>
                </div>
                <div class="messenger-container">
                    <div class="conversations-list">
                        <div class="conversation-header">
                            <h3><i class="fas fa-comments"></i> Cu·ªôc tr√≤ chuy·ªán</h3>
                        </div>
                        <div id="conversations-container">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>
                    <div class="chat-area">
                        <div class="chat-header">
                            <div class="chat-header-left">
                                <div class="chat-header-avatar" id="chat-avatar">?</div>
                                <div class="chat-header-info">
                                    <div class="chat-header-name" id="chat-name">Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</div>
                                    <div class="chat-header-status" id="chat-status">ƒê·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</div>
                                </div>
                            </div>
                            <button class="delete-conversation-btn" id="delete-conversation-btn" onclick="deleteCurrentConversation()" style="display: none;">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                        <div class="chat-messages" id="chat-messages">
                            <div class="no-data">
                                <i class="fas fa-comments"></i>
                                <p>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <button class="image-upload-btn" onclick="document.getElementById('image-upload').click()">
                                <i class="fas fa-image"></i>
                            </button>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="sendImage(event)">
                            <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." disabled>
                            <button id="send-btn" onclick="sendMessage()" disabled>
                                <i class="fas fa-paper-plane"></i> G·ª≠i
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem chi ti·∫øt ƒë∆°n h√†ng -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="order-details" id="orderDetails">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyC_your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let orders = [];
        let conversations = [];
        let currentChatUser = null;
        let ordersUnsubscribe = null;
        let messagesUnsubscribe = null;

        // ========== FIREBASE REAL-TIME LISTENERS ==========

        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebaseListeners();
            setupEventListeners();
        });

        function initializeFirebaseListeners() {
            updateFirebaseStatus('connecting', 'üü° ƒêang k·∫øt n·ªëi Firebase...');

            // L·∫Øng nghe ƒë∆°n h√†ng realtime
            const ordersRef = db.collection("orders");
            const qOrders = ordersRef.orderBy("createdAt", "desc");

            ordersUnsubscribe = qOrders.onSnapshot((snapshot) => {
                orders = [];
                snapshot.forEach(doc => {
                    const order = doc.data();
                    order.id = doc.id;
                    orders.push(order);
                });
                
                loadOrders();
                updateOrderStats();
                updateFirebaseStatus('connected', 'üü¢ ƒê√£ k·∫øt n·ªëi Firebase');
                console.log('üì¶ ƒê√£ t·∫£i', orders.length, 'ƒë∆°n h√†ng t·ª´ Firebase');
            }, (error) => {
                console.error('L·ªói l·∫Øng nghe ƒë∆°n h√†ng:', error);
                updateFirebaseStatus('disconnected', 'üî¥ L·ªói k·∫øt n·ªëi Firebase');
            });

            // L·∫Øng nghe tin nh·∫Øn realtime
            const messagesRef = db.collection("messages");
            const qMessages = messagesRef.orderBy("createdAt", "asc");

            messagesUnsubscribe = qMessages.onSnapshot((snapshot) => {
                processMessages(snapshot);
                loadConversations();
                updateMessageStats();
                console.log('üí¨ ƒê√£ x·ª≠ l√Ω tin nh·∫Øn t·ª´ Firebase');
            }, (error) => {
                console.error('L·ªói l·∫Øng nghe tin nh·∫Øn:', error);
            });
        }

        function processMessages(snapshot) {
            conversations = [];
            const userMessages = {};
            
            snapshot.forEach(doc => {
                const message = doc.data();
                message.id = doc.id;
                
                const userId = message.userId || 'guest';
                
                if (!userMessages[userId]) {
                    userMessages[userId] = {
                        user: userId,
                        messages: [],
                        unread: false,
                        lastMessageTime: message.createdAt?.toDate() || new Date()
                    };
                }
                
                userMessages[userId].messages.push(message);
                
                // ƒê√°nh d·∫•u unread n·∫øu c√≥ tin nh·∫Øn t·ª´ kh√°ch h√†ng ch∆∞a ƒë·ªçc
                if (message.sender === 'user' && !message.read) {
                    userMessages[userId].unread = true;
                }
                
                // C·∫≠p nh·∫≠t th·ªùi gian tin nh·∫Øn cu·ªëi
                const messageTime = message.createdAt?.toDate() || new Date();
                if (messageTime > userMessages[userId].lastMessageTime) {
                    userMessages[userId].lastMessageTime = messageTime;
                }
            });
            
            // Chuy·ªÉn object th√†nh array
            conversations = Object.values(userMessages);
            
            // S·∫Øp x·∫øp theo th·ªùi gian tin nh·∫Øn cu·ªëi (m·ªõi nh·∫•t tr∆∞·ªõc)
            conversations.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
        }

        function updateOrderStats() {
            const pendingCount = orders.filter(o => o.status === 'pending').length;
            const confirmedCount = orders.filter(o => o.status === 'confirmed').length;
            const shippingCount = orders.filter(o => o.status === 'shipping').length;
            const deliveredCount = orders.filter(o => o.status === 'delivered').length;
            
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('confirmed-count').textContent = confirmedCount;
            document.getElementById('shipping-count').textContent = shippingCount;
            document.getElementById('delivered-count').textContent = deliveredCount;
        }

        function updateMessageStats() {
            const unreadCount = conversations.reduce((count, conv) => count + (conv.unread ? 1 : 0), 0);
            document.getElementById('messages-count').textContent = unreadCount;
        }

        function updateFirebaseStatus(status, message) {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.className = `firebase-status status-${status}`;
            statusEl.innerHTML = message;
        }

        // ========== ORDER MANAGEMENT ==========

        function loadOrders() {
            const ordersList = document.getElementById('orders-list');
            
            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-box-open"></i>
                        <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
                        <p>ƒê∆°n h√†ng t·ª´ website s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
                    </div>
                `;
                return;
            }
            
            // Hi·ªÉn th·ªã 5 ƒë∆°n h√†ng m·ªõi nh·∫•t
            const recentOrders = orders.slice(0, 5);
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ ƒêH</th>
                            <th>Ng√†y ƒë·∫∑t</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recentOrders.forEach((order, index) => {
                const statusClass = getStatusClass(order.status);
                const statusText = getStatusText(order.status);
                const orderDate = formatDateTime(order.createdAt?.toDate() || order.orderDate);
                const isNew = isOrderNew(order.createdAt?.toDate() || order.orderDate);
                const rowClass = isNew ? 'order-row-new' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td><span class="order-number">${index + 1}</span></td>
                        <td><strong>${order.orderId || order.id}</strong></td>
                        <td>
                            <div>${orderDate.date}</div>
                            <div class="order-date">${orderDate.time}</div>
                        </td>
                        <td>${order.customerName || order.userId || 'Kh√°ch'}</td>
                        <td>${order.total ? order.total.toLocaleString('vi-VN') + '‚Ç´' : 'N/A'}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn btn-view" onclick="viewOrder('${order.id}')">
                                <i class="fas fa-eye"></i> Xem
                            </button>
                            <button class="action-btn btn-edit" onclick="updateOrderStatus('${order.id}', 'delivered')">
                                <i class="fas fa-check"></i> Ho√†n t·∫•t
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            ordersList.innerHTML = html;
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await db.collection("orders").doc(orderId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng:', newStatus);
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t ƒë∆°n h√†ng:', error);
                alert('‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i! Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        async function viewOrder(orderId) {
            try {
                const doc = await db.collection("orders").doc(orderId).get();
                
                if (!doc.exists) {
                    alert('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!');
                    return;
                }
                
                const order = doc.data();
                showOrderModal(order, orderId);
            } catch (error) {
                console.error('L·ªói l·∫•y th√¥ng tin ƒë∆°n h√†ng:', error);
                alert('‚ùå L·ªói t·∫£i th√¥ng tin ƒë∆°n h√†ng!');
            }
        }

        function showOrderModal(order, orderId) {
            const orderDate = formatDateTime(order.createdAt?.toDate() || order.orderDate);
            
            // T·∫°o HTML cho s·∫£n ph·∫©m
            let productsHtml = '';
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    productsHtml += `
                        <div class="product-item">
                            <img src="${item.image || 'https://via.placeholder.com/60x60?text=No+Image'}" 
                                 alt="${item.name}" 
                                 onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                            <div class="product-info">
                                <div class="product-name">${item.name || 'N/A'}</div>
                                <div class="product-price">
                                    ${item.price ? item.price.toLocaleString('vi-VN') + '‚Ç´' : 'N/A'} x ${item.quantity || 1}
                                </div>
                            </div>
                            <div style="font-weight: bold;">
                                ${((item.price || 0) * (item.quantity || 1)).toLocaleString('vi-VN')}‚Ç´
                            </div>
                        </div>
                    `;
                });
            } else {
                productsHtml = '<p>Kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m</p>';
            }
            
            const orderDetails = `
                <div class="detail-section">
                    <h3>üì¶ Th√¥ng tin ƒë∆°n h√†ng</h3>
                    <p><strong>M√£ ƒë∆°n h√†ng:</strong> ${orderId}</p>
                    <p><strong>Ng√†y ƒë·∫∑t:</strong> ${orderDate.date} ${orderDate.time}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong> 
                        <select class="status-select" id="statusSelect" onchange="updateOrderStatus('${orderId}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="shipping" ${order.status === 'shipping' ? 'selected' : ''}>ƒêang giao</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Ho√†n th√†nh</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                        </select>
                    </p>
                </div>

                <div class="detail-section">
                    <h3>üë§ Th√¥ng tin kh√°ch h√†ng</h3>
                    <p><strong>H·ªç t√™n:</strong> ${order.customerName || order.userId || 'N/A'}</p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${order.phone || 'N/A'}</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.address || 'N/A'}</p>
                    <p><strong>Email:</strong> ${order.email || 'N/A'}</p>
                </div>

                <div class="detail-section">
                    <h3>üõçÔ∏è S·∫£n ph·∫©m</h3>
                    ${productsHtml}
                </div>

                <div class="detail-section">
                    <h3>üí∞ Thanh to√°n</h3>
                    <p><strong>T·ªïng thanh to√°n:</strong> <strong style="color: var(--accent); font-size: 1.2rem;">
                        ${order.total ? order.total.toLocaleString('vi-VN') + '‚Ç´' : 'N/A'}
                    </strong></p>
                    <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${order.paymentMethod || 'N/A'}</p>
                </div>

                <div class="quick-actions">
                    <button class="quick-action-btn btn-confirm" onclick="updateOrderStatus('${orderId}', 'confirmed')">
                        <i class="fas fa-check"></i> X√°c nh·∫≠n ƒë∆°n
                    </button>
                    <button class="quick-action-btn btn-shipping" onclick="updateOrderStatus('${orderId}', 'shipping')">
                        <i class="fas fa-shipping-fast"></i> ƒêang giao
                    </button>
                    <button class="quick-action-btn btn-deliver" onclick="updateOrderStatus('${orderId}', 'delivered')">
                        <i class="fas fa-box"></i> Ho√†n th√†nh
                    </button>
                    <button class="quick-action-btn btn-cancel" onclick="updateOrderStatus('${orderId}', 'cancelled')">
                        <i class="fas fa-times"></i> H·ªßy ƒë∆°n
                    </button>
                </div>
            `;

            document.getElementById('modalTitle').textContent = `ƒê∆°n h√†ng: ${orderId}`;
            document.getElementById('orderDetails').innerHTML = orderDetails;
            document.getElementById('orderModal').style.display = 'flex';
        }

        // ========== CHAT MANAGEMENT ==========

        function loadConversations() {
            const conversationsContainer = document.getElementById('conversations-container');
            const recentMessagesDiv = document.getElementById('recent-messages');
            
            if (conversations.length === 0) {
                conversationsContainer.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-comment-slash"></i>
                        <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p>
                    </div>
                `;
                
                recentMessagesDiv.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-comment-slash"></i>
                        <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
                    </div>
                `;
                return;
            }
            
            // Hi·ªÉn th·ªã danh s√°ch cu·ªôc tr√≤ chuy·ªán
            let conversationsHtml = '';
            conversations.forEach((conv, index) => {
                const lastMessage = conv.messages && conv.messages.length > 0 
                    ? conv.messages[conv.messages.length - 1] 
                    : null;
                
                const activeClass = currentChatUser === conv.user ? 'active' : '';
                const messageTime = lastMessage ? formatDateTime(lastMessage.createdAt?.toDate() || lastMessage.time) : null;
                
                conversationsHtml += `
                    <div class="conversation-item ${activeClass}" onclick="selectConversation('${conv.user}')">
                        <div class="conversation-avatar">${getInitials(conv.user)}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">
                                <span class="order-number">${index + 1}</span> ${conv.user}
                            </div>
                            <div class="conversation-preview">${lastMessage ? (lastMessage.text || 'H√¨nh ·∫£nh') : 'Ch∆∞a c√≥ tin nh·∫Øn'}</div>
                            ${messageTime ? `<div class="conversation-time">${messageTime.date} ${messageTime.time}</div>` : ''}
                        </div>
                        ${conv.unread ? '<div class="conversation-unread">!</div>' : ''}
                    </div>
                `;
            });
            
            conversationsContainer.innerHTML = conversationsHtml;
            
            // Hi·ªÉn th·ªã 3 tin nh·∫Øn g·∫ßn ƒë√¢y nh·∫•t
            const recentConversations = conversations.slice(0, 3);
            let recentMessagesHtml = '';
            
            recentConversations.forEach(conv => {
                const lastMessage = conv.messages && conv.messages.length > 0 
                    ? conv.messages[conv.messages.length - 1] 
                    : null;
                
                if (lastMessage) {
                    const messageTime = formatDateTime(lastMessage.createdAt?.toDate() || lastMessage.time);
                    recentMessagesHtml += `
                        <div class="message-item ${conv.unread ? 'unread' : ''}" onclick="selectConversation('${conv.user}')">
                            <div class="message-sender">${conv.user}</div>
                            <div class="message-preview">${lastMessage.text || 'H√¨nh ·∫£nh'}</div>
                            <div class="message-time">${messageTime.date} ${messageTime.time}</div>
                        </div>
                    `;
                }
            });
            
            recentMessagesDiv.innerHTML = recentMessagesHtml || `
                <div class="no-data">
                    <i class="fas fa-comment-slash"></i>
                    <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
                </div>
            `;
        }

        function selectConversation(user) {
            currentChatUser = user;
            const conversation = conversations.find(c => c.user === user);
            
            if (!conversation) return;
            
            // C·∫≠p nh·∫≠t header chat
            document.getElementById('chat-avatar').textContent = getInitials(user);
            document.getElementById('chat-name').textContent = user;
            document.getElementById('chat-status').textContent = 'ƒêang tr·ª±c tuy·∫øn';
            document.getElementById('delete-conversation-btn').style.display = 'block';
            
            // K√≠ch ho·∫°t input
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            
            // Hi·ªÉn th·ªã tin nh·∫Øn
            displayMessages(conversation.messages || []);
            
            // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
            markMessagesAsRead(user);
        }

        function displayMessages(messages) {
            const chatMessagesDiv = document.getElementById('chat-messages');
            
            if (!messages || messages.length === 0) {
                chatMessagesDiv.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-comments"></i>
                        <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            messages.forEach(msg => {
                const messageClass = msg.sender === 'admin' ? 'admin-message' : 'customer-message';
                const messageTime = formatDateTime(msg.createdAt?.toDate() || msg.time);
                
                if (msg.type === 'image') {
                    // Hi·ªÉn th·ªã tin nh·∫Øn h√¨nh ·∫£nh
                    html += `
                        <div class="message ${messageClass}">
                            <img src="${msg.imageData}" alt="H√¨nh ·∫£nh" style="max-width: 200px; border-radius: 8px;">
                            ${msg.caption ? `<div style="margin-top: 5px;">${msg.caption}</div>` : ''}
                            <div class="message-time">${messageTime.date} ${messageTime.time}</div>
                        </div>
                    `;
                } else {
                    // Hi·ªÉn th·ªã tin nh·∫Øn vƒÉn b·∫£n
                    html += `
                        <div class="message ${messageClass}">
                            <div>${msg.text}</div>
                            <div class="message-time">${messageTime.date} ${messageTime.time}</div>
                        </div>
                    `;
                }
            });
            
            chatMessagesDiv.innerHTML = html;
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            
            if (!messageText || !currentChatUser) return;

            try {
                await db.collection("messages").add({
                    text: messageText,
                    sender: 'admin',
                    userId: currentChatUser,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    read: true
                });
                
                input.value = '';
                console.log('üì§ ƒê√£ g·ª≠i tin nh·∫Øn ƒë·∫øn:', currentChatUser);
            } catch (error) {
                console.error('L·ªói g·ª≠i tin nh·∫Øn:', error);
                alert('‚ùå L·ªói g·ª≠i tin nh·∫Øn! Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        async function sendImage(event) {
            const file = event.target.files[0];
            if (!file || !currentChatUser) return;

            if (!file.type.match('image.*')) {
                alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    await db.collection("messages").add({
                        type: 'image',
                        imageData: e.target.result,
                        sender: 'admin',
                        userId: currentChatUser,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        read: true
                    });
                    
                    console.log('üì§ ƒê√£ g·ª≠i h√¨nh ·∫£nh ƒë·∫øn:', currentChatUser);
                    event.target.value = ''; // Reset input file
                } catch (error) {
                    console.error('L·ªói g·ª≠i h√¨nh ·∫£nh:', error);
                    alert('‚ùå L·ªói g·ª≠i h√¨nh ·∫£nh! Vui l√≤ng th·ª≠ l·∫°i.');
                }
            };
            reader.readAsDataURL(file);
        }

        async function markMessagesAsRead(userId) {
            try {
                // L·∫•y t·∫•t c·∫£ tin nh·∫Øn ch∆∞a ƒë·ªçc c·ªßa user n√†y
                const snapshot = await db.collection("messages")
                    .where("userId", "==", userId)
                    .where("read", "==", false)
                    .get();
                
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { read: true });
                });
                
                await batch.commit();
                
                // C·∫≠p nh·∫≠t l·∫°i conversations
                const conversation = conversations.find(c => c.user === userId);
                if (conversation) {
                    conversation.unread = false;
                    loadConversations();
                }
            } catch (error) {
                console.error('L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc:', error);
            }
        }

        async function deleteCurrentConversation() {
            if (!currentChatUser) return;
            
            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán v·ªõi ${currentChatUser}?`)) {
                try {
                    // L·∫•y t·∫•t c·∫£ tin nh·∫Øn c·ªßa user n√†y
                    const snapshot = await db.collection("messages")
                        .where("userId", "==", currentChatUser)
                        .get();
                    
                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    
                    // Reset chat interface
                    resetChatInterface();
                    console.log('‚úÖ ƒê√£ x√≥a cu·ªôc tr√≤ chuy·ªán v·ªõi:', currentChatUser);
                } catch (error) {
                    console.error('L·ªói x√≥a cu·ªôc tr√≤ chuy·ªán:', error);
                    alert('‚ùå L·ªói x√≥a cu·ªôc tr√≤ chuy·ªán!');
                }
            }
        }

        function resetChatInterface() {
            currentChatUser = null;
            document.getElementById('chat-avatar').textContent = '?';
            document.getElementById('chat-name').textContent = 'Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán';
            document.getElementById('chat-status').textContent = 'ƒê·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán';
            document.getElementById('delete-conversation-btn').style.display = 'none';
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('chat-messages').innerHTML = `
                <div class="no-data">
                    <i class="fas fa-comments"></i>
                    <p>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                </div>
            `;
        }

        // ========== UTILITY FUNCTIONS ==========

        function getStatusClass(status) {
            const statusClasses = {
                'pending': 'status-pending',
                'confirmed': 'status-confirmed',
                'shipping': 'status-shipping',
                'delivered': 'status-delivered',
                'cancelled': 'status-cancelled'
            };
            return statusClasses[status] || 'status-pending';
        }

        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'confirmed': 'ƒê√£ x√°c nh·∫≠n',
                'shipping': 'ƒêang giao',
                'delivered': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusTexts[status] || 'Ch·ªù x·ª≠ l√Ω';
        }

        function getInitials(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        function formatDateTime(date) {
            if (!date) return { date: '', time: '' };
            
            try {
                const dateObj = date instanceof Date ? date : new Date(date);
                if (isNaN(dateObj.getTime())) {
                    return { date: 'N/A', time: '' };
                }
                
                const dateStr = dateObj.toLocaleDateString('vi-VN');
                const timeStr = dateObj.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return { date: dateStr, time: timeStr };
            } catch (error) {
                return { date: 'N/A', time: '' };
            }
        }

        function isOrderNew(orderDate) {
            if (!orderDate) return false;
            
            try {
                const orderTime = new Date(orderDate).getTime();
                const now = new Date().getTime();
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                return (now - orderTime) < twentyFourHours;
            } catch (error) {
                return false;
            }
        }

        function setupEventListeners() {
            // G·ª≠i tin nh·∫Øn b·∫±ng ph√≠m Enter
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function exportToExcel() {
            if (orders.length === 0) {
                alert('Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒë·ªÉ xu·∫•t!');
                return;
            }
            
            const excelData = orders.map(order => {
                const productsString = order.items ? order.items.map(item => 
                    `${item.name} (SL: ${item.quantity || 1})`
                ).join('; ') : 'Kh√¥ng c√≥ s·∫£n ph·∫©m';
                
                const orderDate = formatDateTime(order.createdAt?.toDate() || order.orderDate);
                
                return {
                    'M√£ ƒêH': order.orderId || order.id,
                    'Kh√°ch h√†ng': order.customerName || order.userId || 'Kh√°ch',
                    'SƒêT': order.phone || 'N/A',
                    'ƒê·ªãa ch·ªâ': order.address || 'N/A',
                    'S·∫£n ph·∫©m': productsString,
                    'T·ªïng ti·ªÅn': order.total || 0,
                    'PTTT': order.paymentMethod || 'N/A',
                    'Tr·∫°ng th√°i': getStatusText(order.status),
                    'Ng√†y ƒë·∫∑t': orderDate.date + ' ' + orderDate.time
                };
            });
            
            try {
                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ƒê∆°n h√†ng");
                
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `don_hang_${date}.xlsx`);
                alert(`ƒê√£ xu·∫•t file Excel th√†nh c√¥ng! T·ªïng ${orders.length} ƒë∆°n h√†ng.`);
            } catch (error) {
                console.error('L·ªói xu·∫•t Excel:', error);
                alert('C√≥ l·ªói khi xu·∫•t file Excel!');
            }
        }

        async function clearAllData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                try {
                    // X√≥a t·∫•t c·∫£ ƒë∆°n h√†ng
                    const ordersSnapshot = await db.collection("orders").get();
                    const ordersBatch = db.batch();
                    ordersSnapshot.forEach(doc => {
                        ordersBatch.delete(doc.ref);
                    });
                    await ordersBatch.commit();

                    // X√≥a t·∫•t c·∫£ tin nh·∫Øn
                    const messagesSnapshot = await db.collection("messages").get();
                    const messagesBatch = db.batch();
                    messagesSnapshot.forEach(doc => {
                        messagesBatch.delete(doc.ref);
                    });
                    await messagesBatch.commit();

                    alert('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!');
                } catch (error) {
                    console.error('L·ªói x√≥a d·ªØ li·ªáu:', error);
                    alert('‚ùå L·ªói x√≥a d·ªØ li·ªáu!');
                }
            }
        }

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // D·ªçn d·∫πp listeners khi trang ƒë√≥ng
        window.addEventListener('beforeunload', function() {
            if (ordersUnsubscribe) ordersUnsubscribe();
            if (messagesUnsubscribe) messagesUnsubscribe();
        });

        console.log('üöÄ Admin Dashboard v·ªõi Firebase ƒë√£ s·∫µn s√†ng!');
    </script>

<!-- Firebase helpers -->
<script type="module">
  // Firebase app already expected in js/firebase-config.js (exports: db, auth, storage)
  import { db, auth, storage } from "./js/firebase-config.js";
  import { collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
  // helper functions used by injected code
  window._firebase_helpers = {
    addOrder: async (order) => {
      return await addDoc(collection(db, "orders"), { ...order, status: "pending", createdAt: serverTimestamp() });
    },
    sendChatMessage: async (userId, message) => {
      // message: { text, sender, imageUrl? }
      const chatCol = collection(db, "chats", userId, "messages");
      return await addDoc(chatCol, { ...message, createdAt: serverTimestamp() });
    },
    uploadImageAndGetUrl: async (file, pathPrefix="chat_images") => {
      const p = `${pathPrefix}/${Date.now()}_${file.name}`;
      const sRef = storageRef(storage, p);
      const snap = await uploadBytes(sRef, file);
      const url = await getDownloadURL(snap.ref);
      return url;
    },
    listenOrders: (onUpdate) => {
      const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
      return onSnapshot(q, onUpdate);
    },
    listenUserChatsList: (onUpdate) => {
      // get all chats (root 'chats' collection) -> list userIds with latest message
      const chatsRoot = collection(db, "chats");
      // Note: Firestore doesn't allow easy list of subcollections; admin will fetch by listing chat documents (we will store a 'meta' doc per user in 'chats_meta')
      const qmeta = query(collection(db, "chats_meta"), orderBy("lastUpdated", "desc"));
      return onSnapshot(qmeta, onUpdate);
    },
    listenChatMessages: (userId, onUpdate) => {
      const q = query(collection(db, "chats", userId, "messages"), orderBy("createdAt", "asc"));
      return onSnapshot(q, onUpdate);
    }
  };
</script>
<script type="module">
import { auth } from './js/firebase-config.js';
// Admin credentials check and redirect if not admin
auth.onAuthStateChanged(async user => {
  const adminEmail = 'admin@tinytags.com';
  if(!user){
    // show a simple login form inline if needed
    const loginForm = document.getElementById('admin-login-form');
    if(loginForm){
      loginForm.style.display = 'block';
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginForm.querySelector('input[name=email]').value;
        const password = loginForm.querySelector('input[name=password]').value;
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch(err){
          alert('ƒêƒÉng nh·∫≠p l·ªói: ' + err.message);
        }
      });
    } else {
      window.location.href = 'login.html';
    }
    return;
  }
  if(user.email !== adminEmail){
    alert('B·∫°n kh√¥ng c√≥ quy·ªÅn admin');
    window.location.href = 'index.html';
    return;
  }

  // At this point user is admin
  // Listen orders realtime and show notification bell
  const ordersContainer = document.getElementById('orders-list') || document.querySelector('.orders-list');
  const bellEl = document.getElementById('order-bell') || document.querySelector('.order-bell');

  window._firebase_helpers.listenOrders((snap) => {
    if(!ordersContainer) return;
    ordersContainer.innerHTML = '';
    snap.forEach(docSnap => {
      const o = docSnap.data();
      const id = docSnap.id;
      const div = document.createElement('div');
      div.className = 'order-card';
      div.innerHTML = `<p><b>ID:</b> ${id}</p><p><b>Kh√°ch:</b> ${o.customerName || o.userId}</p><p><b>T·ªïng:</b> ${o.total}</p><p><b>Tr·∫°ng th√°i:</b> ${o.status}</p><button data-id="${id}" class="mark-done">Ho√†n t·∫•t</button>`;
      ordersContainer.appendChild(div);
    });
    // show bell indicator
    if(bellEl){
      bellEl.classList.add('has-new');
    }
  });

  // Admin chat: show list of chat users from chats_meta collection
  const usersListEl = document.getElementById('chat-users') || document.querySelector('.chat-users');
  const chatMessagesEl = document.getElementById('chat-list') || document.querySelector('.chat-list');

  window._firebase_helpers.listenUserChatsList((snap) => {
    if(!usersListEl) return;
    usersListEl.innerHTML = '';
    snap.forEach(docSnap => {
      const meta = docSnap.data();
      const uid = docSnap.id;
      const li = document.createElement('div');
      li.className = 'chat-user';
      li.innerHTML = `<button data-uid="${uid}" class="open-chat">${meta.displayName || uid}</button><small>${meta.lastMessage || ''}</small>`;
      usersListEl.appendChild(li);
    });
    // attach click handlers
    document.querySelectorAll('.open-chat').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const uid = e.target.dataset.uid;
        openChat(uid);
      });
    });
  });

  let currentUnsub = null;
  window.openChat = (uid) => {
    if(currentUnsub) currentUnsub(); // unsubscribe previous
    chatMessagesEl.innerHTML = '';
    currentUnsub = window._firebase_helpers.listenChatMessages(uid, (snap) => {
      chatMessagesEl.innerHTML = '';
      snap.forEach(docSnap => {
        const m = docSnap.data();
        const p = document.createElement('p');
        let inner = '';
        if(m.imageUrl) inner += `<div><img src="${m.imageUrl}" style="max-width:200px"/></div>`;
        inner += `<div>${m.text || ''}</div><small>${m.sender}</small>`;
        p.innerHTML = inner;
        chatMessagesEl.appendChild(p);
      });
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    });
    // attach send reply form
    const replyForm = document.getElementById('adminReplyForm');
    if(replyForm){
      replyForm.onsubmit = async (e) => {
        e.preventDefault();
        const text = replyForm.querySelector('input[name=reply]')?.value || replyForm.querySelector('textarea[name=reply]')?.value || '';
        const fileInput = replyForm.querySelector('input[type=file]');
        let imageUrl = null;
        if(fileInput && fileInput.files && fileInput.files[0]){
          try {
            imageUrl = await window._firebase_helpers.uploadImageAndGetUrl(fileInput.files[0]);
          } catch(err){ console.error('upload error', err); }
        }
        if(!text && !imageUrl) return;
        await window._firebase_helpers.sendChatMessage(uid, { text, sender: 'admin', imageUrl });
        if(replyForm.querySelector('input[name=reply]')) replyForm.querySelector('input[name=reply]').value='';
        if(replyForm.querySelector('textarea[name=reply]')) replyForm.querySelector('textarea[name=reply]').value='';
        if(fileInput) fileInput.value='';
      };
    }
  };
});
</script>
</body>
</html>